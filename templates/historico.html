<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ðŸ“Š HistÃ³rico de RTP</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
</head>
<body>
  <div class="container py-3">
    <div class="mb-3 d-flex gap-2">
      <input id="search-name" type="text" class="form-control" placeholder="Pesquisar jogo" />
      <select id="period" class="form-select w-auto">
        <option value="daily">DiÃ¡rio</option>
        <option value="weekly">Semanal</option>
        <option value="monthly">Mensal</option>
      </select>
      <button id="btn-search" class="btn btn-primary">Buscar</button>
      <a href="/" class="btn btn-secondary">Voltar</a>
    </div>
    <canvas id="chart" class="mb-4"></canvas>
    <table class="table table-dark table-striped" id="history-table">
      <thead>
        <tr>
          <th>Jogo</th>
          <th>Provedor</th>
          <th>PerÃ­odo</th>
          <th>RTP MÃ©dio</th>
          <th>Unidades MÃ©dias</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <script>
    document.getElementById('btn-search').addEventListener('click', loadHistory);
    async function loadHistory() {
      const search = document.getElementById('search-name').value.trim();
      const period = document.getElementById('period').value;
      let url = `/api/history?period=${period}`;
      if (search) {
        if (/^\d+$/.test(search)) {
          url += `&game_id=${encodeURIComponent(search)}`;
        } else {
          url += `&name=${encodeURIComponent(search)}`;
        }
      }
      const resp = await fetch(url);
      if (!resp.ok) return;
      const data = await resp.json();
      renderTable(data);
      renderChart(data);
    }
    function renderTable(rows) {
      const tbody = document.querySelector('#history-table tbody');
      tbody.innerHTML = '';
      for (const row of rows) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${row.name}</td><td>${row.provider}</td><td>${row.periodo}</td><td>${(Number(row.rtp) / 100).toFixed(2)}</td><td>${Number(row.extra).toFixed(2)}</td>`;
        tbody.appendChild(tr);
      }
    }
    let chart;
    function renderChart(rows) {
      const labels = rows.map(r => r.periodo);
      const valores = rows.map(r => r.rtp / 100);
      if (chart) chart.destroy();
      chart = new Chart(document.getElementById('chart'), {
        type: 'line',
        data: { labels, datasets: [{ label: 'RTP MÃ©dio', data: valores, borderColor: 'rgb(75, 192, 192)', tension: 0.1 }] },
      });
    }
  </script>
</body>
</html>
